// Generated by CoffeeScript 1.6.2
var CGI;

if (SOW_RECORD.CABALA.events != null) {
  SOW.events.keys(function(k, v) {
    v.id = SOW_RECORD.CABALA.events.indexOf(k);
    return v.key = k;
  });
}

CGI = function($scope, $filter) {
  var get, regexp, submit;

  $scope.mode_current_set = function() {
    return $scope.mode_current = 'talk_all_open_player';
  };
  get = function(href, cb) {
    return $scope.get(href + "&ua=javascript", cb);
  };
  $scope.event_url = function(event) {
    if (!event) {
      return null;
    }
    return (event.is_news && event.news) || event.link;
  };
  $scope.get_news = function(event, cb) {
    var href;

    href = $scope.event_url(event);
    if (href) {
      return get(href, cb);
    }
  };
  $scope.get_all = function(event, cb) {
    var href;

    if (!event) {
      return null;
    }
    href = event.link;
    if (href) {
      return get(href, cb);
    }
  };
  submit = function(param, cb) {
    var protocol;

    switch (param.cmd) {
      case 'login':
        if (param.vid != null) {
          protocol = $scope.post_iframe;
        } else {
          protocol = $scope.post_submit;
        }
        break;
      case 'editvilform':
      case 'logout':
        protocol = $scope.post_submit;
        break;
      case 'wrmemo':
      case 'write':
      case 'action':
      case 'entry':
        protocol = $scope.post_iframe;
        break;
      default:
        protocol = $scope.post;
    }
    if ($scope.post_submit !== protocol) {
      param.ua = "javascript";
    }
    return protocol($scope.form.uri, param, function() {
      $scope.init();
      return cb();
    });
  };
  $scope.submit = submit.throttle(5000);
  regexp = {
    uid: /(^|\s)uid=([^;]+)/,
    pwd: /(^|\s)pwd=([^;]+)/
  };
  $scope.logined = function() {
    var pwd, uid, _ref, _ref1;

    uid = (_ref = document.cookie.match(regexp.uid)) != null ? _ref[2] : void 0;
    pwd = (_ref1 = document.cookie.match(regexp.pwd)) != null ? _ref1[2] : void 0;
    return (uid != null) && (pwd != null);
  };
  $scope.login = function(f) {
    var param, _ref;

    f.uid = $("[name=\"uid\"]").val();
    f.pwd = $("[name=\"pwd\"]").val();
    param = {
      cmd: 'login',
      uid: f.uid,
      pwd: f.pwd,
      cmdfrom: f.cmdfrom
    };
    if (((_ref = $scope.story) != null ? _ref.vid : void 0) != null) {
      param.vid = $scope.story.vid;
    }
    return $scope.submit(param, function() {});
  };
  $scope.logout = function(f) {
    var param;

    param = {
      cmd: 'logout',
      cmdfrom: f.cmdfrom
    };
    return $scope.submit(param, function() {});
  };
  MODULE($scope, $filter);
  return FORM($scope);
};
