(function(a){var b={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,allowCreation:false,hintText:"タイプして検索しましょう",noResultsText:"見つかりません",searchingText:"Searching...",deleteText:"x",createTokenText:"(新しく作成)",animateDropdown:true,tokenLimit:null,tokenDelimiter:",",preventDuplicates:false,tokenValue:"id",prePopulate:null,processPrePopulate:false,idPrefix:"token-input-",resultsFormatter:function(a){return"<li>"+a[this.propertyToSearch]+"</li>"},tokenFormatter:function(a){return"<li><p>"+a[this.propertyToSearch]+"</p></li>"},onResult:null,onCreate:null,onAdd:null,onDelete:null,onReady:null};var c={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"};var d={BEFORE:0,AFTER:1,END:2};var e={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};var f={init:function(c,d){var e=a.extend({},b,d||{});return this.each(function(){a(this).data("tokenInputObject",new a.TokenList(this,c,e))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(a){this.data("tokenInputObject").add(a);return this},remove:function(a){this.data("tokenInputObject").remove(a);return this},get:function(){return this.data("tokenInputObject").getTokens()}};a.fn.tokenInput=function(a){if(f[a]){return f[a].apply(this,Array.prototype.slice.call(arguments,1))}else{return f.init.apply(this,arguments)}};a.TokenList=function(b,f,g){function T(){var a=g.url;if(typeof g.url=="function"){a=g.url.call()}return a}function S(b){var c={};c[g.propertyToSearch]=n.val()+" "+g.createTokenText;c[g.tokenValue]=n.val();c["wasCreated"]=true;b.push(c);if(a.isFunction(g.onCreate)){var d={};d[g.propertyToSearch]=n.val();d[g.tokenValue]=n.val();g.onCreate.call(o,d)}}function R(b){var c=b+T();var d=k.get(c);if(d){N(b,d)}else{if(g.url){var e=T();var f={};f.data={};if(e.indexOf("?")>-1){var h=e.split("?");f.url=h[0];var i=h[1].split("&");a.each(i,function(a,b){var c=b.split("=");f.data[c[0]]=c[1]})}else{f.url=e}f.data[g.queryParam]=b;f.type=g.method;f.dataType=g.contentType;if(g.crossDomain){f.dataType="jsonp"}f.success=function(d){if(a.isFunction(g.onResult)){d=g.onResult.call(o,d)}if(g.allowCreation){S(d)}else{k.add(c,g.jsonContainer?d[g.jsonContainer]:d)}if(n.val().toLowerCase()===b.toLowerCase()){N(b,g.jsonContainer?d[g.jsonContainer]:d)}};a.ajax(f)}else if(g.local_data){var j=a.grep(g.local_data,function(a){return a[g.propertyToSearch].toLowerCase().indexOf(b.toLowerCase())>-1});if(a.isFunction(g.onResult)){j=g.onResult.call(o,j)}if(g.allowCreation){S(j)}else{k.add(c,j)}N(b,j)}}}function Q(){var b=n.val().toLowerCase();if(b&&b.length){if(p){D(a(p),d.AFTER)}if(b.length>=g.minChars){J();clearTimeout(l);l=setTimeout(function(){R(b)},g.searchDelay)}else{H()}}}function P(a){a.removeClass(g.classes.selectedDropdownItem);r=null}function O(b){if(b){if(r){P(a(r))}b.addClass(g.classes.selectedDropdownItem);r=b.get(0)}}function N(b,c){if(c&&c.length){u.empty();var d=a("<ul>").appendTo(u).mouseover(function(b){O(a(b.target).closest("li"))}).mousedown(function(b){B(a(b.target).closest("li").data("tokeninput"));o.change();return false}).hide();a.each(c,function(c,e){var f=g.resultsFormatter(e);f=M(f,e[g.propertyToSearch],b);f=a(f).appendTo(d);if(c%2){f.addClass(g.classes.dropdownItem)}else{f.addClass(g.classes.dropdownItem2)}if(c===0){O(f)}a.data(f.get(0),"tokeninput",e)});I();if(g.animateDropdown){d.slideDown("fast")}else{d.show()}}else{if(g.noResultsText){u.html("<p>"+g.noResultsText+"</p>");I()}}}function M(a,b,c){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","g"),L(b,c))}function L(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")}function K(){if(g.hintText){u.html("<p>"+g.hintText+"</p>");I()}}function J(){if(g.searchingText){u.html("<p>"+g.searchingText+"</p>");I()}}function I(){u.css({position:"absolute",top:a(s).offset().top+a(s).outerHeight(),left:a(s).offset().left,zindex:999}).show()}function H(){u.hide().empty();r=null}function G(b,c){var d=a.map(b,function(a){return a[g.tokenValue]});c.val(d.join(g.tokenDelimiter))}function F(b){var c=a.data(b.get(0),"tokeninput");var d=g.onDelete;var e=b.prevAll().length;if(e>q)e--;b.remove();p=null;n.focus();i=i.slice(0,e).concat(i.slice(e+1));if(e<q)q--;G(i,o);j-=1;if(g.tokenLimit!==null){n.show().val("").focus()}if(a.isFunction(d)){d.call(o,c)}}function E(b){var c=p;if(p){D(a(p),d.END)}if(c===b.get(0)){D(b,d.END)}else{C(b)}}function D(a,b){a.removeClass(g.classes.selectedToken);p=null;if(b===d.BEFORE){t.insertBefore(a);q--}else if(b===d.AFTER){t.insertAfter(a);q++}else{t.appendTo(s);q=j}n.focus()}function C(a){a.addClass(g.classes.selectedToken);p=a.get(0);n.val("");H()}function B(b){var c=g.onAdd;if(j>0&&g.preventDuplicates){var d=null;s.children().each(function(){var c=a(this);var e=a.data(c.get(0),"tokeninput");if(e&&(e.id===b.id||b.wasCreated&&e.name===b.name)){d=c;return false}});if(d){C(d);t.insertAfter(d);n.focus();return}}if(g.allowCreation&&b.wasCreated){g.tokenValue=="id"?b.name=b.id:b.name=b[g.tokenValue]}if(g.tokenLimit==null||j<g.tokenLimit){A(b);x()}n.val("");H();if(a.isFunction(c)){c.call(o,b)}}function A(b){var c=g.tokenFormatter(b);c=a(c).addClass(g.classes.token).insertBefore(t);a("<span>"+g.deleteText+"</span>").addClass(g.classes.tokenDelete).appendTo(c).click(function(){F(a(this).parent());o.change();return false});var d={id:b.id};d[g.propertyToSearch]=b[g.propertyToSearch];a.data(c.get(0),"tokeninput",b);i=i.slice(0,q).concat([d]).concat(i.slice(q));q++;G(i,o);j+=1;if(g.tokenLimit!==null&&j>=g.tokenLimit){n.hide();H()}return c}function z(a){return a>=48&&a<=90||a>=96&&a<=111||a>=186&&a<=192||a>=219&&a<=222}function y(){if(m===(m=n.val())){return}var a=m.replace(/&/g,"&").replace(/\s/g," ").replace(/</g,"<").replace(/>/g,">");v.html(a);n.width(v.width()+30)}function x(){if(g.tokenLimit!==null&&j>=g.tokenLimit){n.hide();H();return}}if(a.type(f)==="string"||a.type(f)==="function"){g.url=f;var h=T();if(g.crossDomain===undefined){if(h.indexOf("://")===-1){g.crossDomain=false}else{g.crossDomain=location.href.split(/\/+/g)[1]!==h.split(/\/+/g)[1]}}}else if(typeof f==="object"){g.local_data=f}if(g.classes){g.classes=a.extend({},c,g.classes)}else if(g.theme){g.classes={};a.each(c,function(a,b){g.classes[a]=b+"-"+g.theme})}else{g.classes=c}var i=[];var j=0;var k=new a.TokenList.Cache;var l;var m;var n=a('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",g.idPrefix+b.id).focus(function(){if(g.tokenLimit===null||g.tokenLimit!==j){K()}}).blur(function(){H();a(this).val("")}).bind("keyup keydown blur update",y).keydown(function(b){var c;var f;switch(b.keyCode){case e.LEFT:case e.RIGHT:case e.UP:case e.DOWN:if(!a(this).val()){c=t.prev();f=t.next();if(c.length&&c.get(0)===p||f.length&&f.get(0)===p){if(b.keyCode===e.LEFT||b.keyCode===e.UP){D(a(p),d.BEFORE)}else{D(a(p),d.AFTER)}}else if((b.keyCode===e.LEFT||b.keyCode===e.UP)&&c.length){C(a(c.get(0)))}else if((b.keyCode===e.RIGHT||b.keyCode===e.DOWN)&&f.length){C(a(f.get(0)))}}else{var g=null;if(b.keyCode===e.DOWN||b.keyCode===e.RIGHT){g=a(r).next()}else{g=a(r).prev()}if(g.length){O(g)}return false}break;case e.BACKSPACE:c=t.prev();if(!a(this).val().length){if(p){F(a(p));o.change()}else if(c.length){C(a(c.get(0)))}return false}else if(a(this).val().length===1){H()}else{setTimeout(function(){Q()},5)}break;case e.TAB:case e.ENTER:case e.NUMPAD_ENTER:case e.COMMA:if(r){B(a(r).data("tokeninput"));o.change();return false}break;case e.ESCAPE:H();return true;default:if(String.fromCharCode(b.which)){setTimeout(function(){Q()},5)}break}});var o=a(b).hide().val("").focus(function(){n.focus()}).blur(function(){n.blur()});var p=null;var q=0;var r=null;var s=a("<ul />").addClass(g.classes.tokenList).click(function(b){var c=a(b.target).closest("li");if(c&&c.get(0)&&a.data(c.get(0),"tokeninput")){E(c)}else{if(p){D(a(p),d.END)}n.focus()}}).mouseover(function(b){var c=a(b.target).closest("li");if(c&&p!==this){c.addClass(g.classes.highlightedToken)}}).mouseout(function(b){var c=a(b.target).closest("li");if(c&&p!==this){c.removeClass(g.classes.highlightedToken)}}).insertBefore(o);var t=a("<li />").addClass(g.classes.inputToken).appendTo(s).append(n);var u=a("<div>").addClass(g.classes.dropdown).appendTo("body").hide();var v=a("<tester/>").insertAfter(n).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:n.css("fontSize"),fontFamily:n.css("fontFamily"),fontWeight:n.css("fontWeight"),letterSpacing:n.css("letterSpacing"),whiteSpace:"nowrap"});o.val("");var w=g.prePopulate||o.data("pre");if(g.processPrePopulate&&a.isFunction(g.onResult)){w=g.onResult.call(o,w)}if(w&&w.length){a.each(w,function(a,b){A(b);x()})}if(a.isFunction(g.onReady)){g.onReady.call()}this.clear=function(){s.children("li").each(function(){if(a(this).children("input").length===0){F(a(this))}})};this.add=function(a){B(a)};this.remove=function(b){s.children("li").each(function(){if(a(this).children("input").length===0){var c=a(this).data("tokeninput");var d=true;for(var e in b){if(b[e]!==c[e]){d=false;break}}if(d){F(a(this))}}})};this.getTokens=function(){return i}};a.TokenList.Cache=function(b){var c=a.extend({max_size:500},b);var d={};var e=0;var f=function(){d={};e=0};this.add=function(a,b){if(e>c.max_size){f()}if(!d[a]){e+=1}d[a]=b};this.get=function(a){return d[a]}}})(jQuery)
